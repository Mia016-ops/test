name: Notify User on Status Update

# 1. 触发器：当 Issue 被添加标签 (labeled) 或重新打开 (reopened) 时触发
on:
  issues:
    types: [labeled, reopened]

jobs:
  send_email_update:
    runs-on: ubuntu-latest

    # 2. 优化后的条件判断：判断是否为 'status: resolved' 标签，并且确保事件类型是 labeled 
    #    (reopened 事件没有 label 属性，直接访问会出错，虽然不致命，但最好排除)
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'status: resolved'

    steps:
      # --- 新增调试步骤：打印 Issue Body 内容和事件信息 ---
      - name: Debug Event and Issue Body
        run: |
          echo "GitHub Event Name: ${{ github.event_name }}"
          echo "GitHub Event Action: ${{ github.event.action }}"
          echo "Issue Label Name: ${{ github.event.label.name }}"
          echo "--- Issue Body ---"
          echo "${{ github.event.issue.body }}"
          echo "------------------"

      # 3. 提取用户邮箱地址 (提取逻辑不变)
      - name: Extract User Email
        id: extract_email
        run: |
          # 确保您的 Issue Body 中包含 '原始用户邮箱:' 这段文字
          EMAIL=$(echo "${{ github.event.issue.body }}" | grep "原始用户邮箱:" | awk '{print $NF}')

          # 确保提取到了邮箱，否则流程失败
          if [ -z "$EMAIL" ]; then
            echo "Error: User email not found in issue body. Stopping job."
            exit 1
          fi

          echo "Extracted Email: $EMAIL"
          echo "user_email=$EMAIL" >> $GITHUB_OUTPUT
        shell: bash

      # 4. 发送邮件
      - name: Send Resolution Email
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP 配置 (使用您在 Secrets 中配置的变量)
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          # 邮件内容配置
          subject: '工单更新：您的 Bug/功能请求 # ${{ github.event.issue.number }} 已解决'
          to: ${{ steps.extract_email.outputs.user_email }}
          from: ${{ secrets.SMTP_USERNAME }}
          # 邮件正文
          body: |
            # ... (邮件正文保持不变)
            尊敬的用户您好,

            感谢您的耐心等待。我们很高兴通知您，您提交的工单：
            **${{ github.event.issue.title }}**

            已在 GitHub 上标记为 **已解决 (Resolved)**。

            我们已发布更新或找到了解决方案。

            您可以在此链接查看 Issue 详情:
            ${{ github.event.issue.html_url }}

            如果您有任何疑问，请随时回复此邮件。

            此致，
            [您的团队名称]
