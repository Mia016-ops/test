name: Notify User on Status Update

# 1. 触发器：监听 Issue 被添加标签或重新打开的事件
on:
  issues:
    types: [labeled, reopened]

jobs:
  send_email_update:
    runs-on: ubuntu-latest
    
    # 2. 严格的条件判断：确保事件是 'labeled' 且 标签名为 'status: resolved'
    #    请务必确认您的 GitHub 标签名称是 'status: resolved'
    if: github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'status: resolved'

    steps:
      # --- 1. 调试步骤：打印 Issue Body 内容和事件信息 ---
      - name: Debug Event and Issue Body
        run: |
          echo "GitHub Event Name: ${{ github.event_name }}"
          echo "GitHub Event Action: ${{ github.event.action }}"
          echo "Issue Label Name: ${{ github.event.label.name }}"
          echo "--- Issue Body ---"
          echo "${{ github.event.issue.body }}"
          echo "------------------"

      # 3. 提取用户邮箱地址
      - name: Extract User Email
        id: extract_email
        run: |
          # 提取逻辑：查找 '原始用户邮箱:' 这一行，并提取该行最后一个字段 (邮箱地址)
          EMAIL=$(echo "${{ github.event.issue.body }}" | grep "原始用户邮箱:" | awk '{print $NF}')

          # 确保提取到了邮箱，否则流程失败
          if [ -z "$EMAIL" ]; then
            echo "Error: User email not found in issue body. Stopping job."
            exit 1
          fi

          echo "Extracted Email: $EMAIL"
          echo "user_email=$EMAIL" >> $GITHUB_OUTPUT
        shell: bash

      # 4. 发送邮件
      - name: Send Resolution Email
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP 配置 (使用 Secrets)
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          # 邮件内容配置
          subject: '工单更新：您的 Bug/功能请求 # ${{ github.event.issue.number }} 已解决'
          to: ${{ steps.extract_email.outputs.user_email }}
          from: ${{ secrets.SMTP_USERNAME }}
          # 邮件正文
          body: |
            尊敬的用户您好,

            感谢您的耐心等待。我们很高兴通知您，您提交的工单：
            **${{ github.event.issue.title }}**

            已在 GitHub 上标记为 **已解决 (Resolved)**。

            我们已发布更新或找到了解决方案。

            您可以在此链接查看 Issue 详情:
            ${{ github.event.issue.html_url }}

            如果您有任何疑问，请随时回复此邮件。

            此致，
            Filo
