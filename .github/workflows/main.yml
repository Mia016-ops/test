# è§¦å‘æ¡ä»¶ï¼šå½“ Issue è¢«ç¼–è¾‘ï¼ˆåŒ…æ‹¬æ ‡ç­¾æ›´æ”¹ï¼‰æ—¶
on:
  issues:
    types: [labeled, unlabeled]

jobs:
  send_email_on_resolved:
    # ä»…åœ¨ Issue æ ‡ç­¾åŒ…å« 'resolved' ä¸” 'unlabeled' äº‹ä»¶æœªå‘ç”Ÿæ—¶è¿è¡Œ
    if: |
      github.event.action == 'labeled' &&
      contains(github.event.issue.labels.*.name, 'resolved')
    runs-on: ubuntu-latest
    
    steps:
      # 1. æå–æ”¶ä»¶äººé‚®ç®±
      - name: ğŸ“© Extract Email from Issue Body
        id: extract_email
        run: |
          # æå– Issue Body çš„ç¬¬ä¸€è¡Œ
          first_line=$(echo "${{ github.event.issue.body }}" | head -n 1)
          # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä»ç¬¬ä¸€è¡Œä¸­æå–é‚®ä»¶åœ°å€ï¼ˆå‡è®¾é‚®ç®±åœ¨ ':', 'ï¼š', ' ' ä¹‹åï¼‰
          email=$(echo "$first_line" | grep -o -E '([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)')
          
          if [ -z "$email" ]; then
            echo "::error::Could not find email address in the issue body. Skipping email."
            # å¦‚æœæ‰¾ä¸åˆ°é‚®ä»¶ï¼Œå¯ä»¥è®¾ç½®ä¸ºä¸€ä¸ªä¸å‘é€çš„ç‰¹æ®Šå€¼ï¼Œæˆ–è€…ç›´æ¥è®©å·¥ä½œæµå¤±è´¥
            echo "extracted_email=no-reply@example.com" >> $GITHUB_OUTPUT
          else
            echo "Extracted email: $email"
            echo "extracted_email=$email" >> $GITHUB_OUTPUT
          fi
        shell: bash

      # 2. å‘é€ Resolved é€šçŸ¥é‚®ä»¶
      - name: âœ‰ï¸ Send Resolved Notification Email
        uses: dawidd6/action-send-mail@v3
        # ä»…åœ¨æˆåŠŸæå–åˆ°é‚®ç®±åæ‰è¿è¡Œ
        if: success() && steps.extract_email.outputs.extracted_email != 'no-reply@example.com'
        with:
          # ... (SMTP é…ç½®ä¸å˜) ...
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.MAIL_FROM }}
          
          # ä½¿ç”¨ä¸Šä¸€æ­¥éª¤æå–çš„é‚®ç®±ä½œä¸ºæ”¶ä»¶äºº
          to: ${{ steps.extract_email.outputs.extracted_email }}
          
          # ... (é‚®ä»¶å†…å®¹é…ç½®ä¸å˜) ...
          subject: "[Resolved] Issue # ${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
          html_body: |
            <p>Dear reporterï¼Œ</p>
            <p>Your submitted GitHub Issue status has been updated:</p>
            <ul>
              <li><strong>Issue Title:</strong> <a href="${{ github.event.issue.html_url }}">${{ github.event.issue.title }}</a></li>
              <li><strong>New status:</strong> <strong> Resolved </strong></li>
            </ul>
            <p><strong><a href="${{ github.event.issue.html_url }}">Click here to view the Issue details.</a></strong></p>
            <br>
            <p>Please note: This email was sent automatically by GitHub Actions. Please do not reply directly.</p>
