# è§¦å‘æ¡ä»¶ï¼šä»…å½“ Issue å‘ç”Ÿäº† æ·»åŠ æ ‡ç­¾ çš„åŠ¨ä½œï¼ˆè€Œä¸æ˜¯ç§»é™¤æ ‡ç­¾ï¼‰ï¼Œå¹¶ä¸” åœ¨è¿™æ¬¡æ“ä½œä¹‹åï¼Œè¯¥ Issue çš„æ ‡ç­¾åˆ—è¡¨ä¸­åŒ…å«äº† 'resolved' æ ‡ç­¾æ—¶ï¼Œè¿™ä¸ªä½œä¸šæ‰ä¼šè¿è¡Œã€‚
on:
  # è§¦å‘æ¡ä»¶: å½“ Issue è¢«ç¼–è¾‘ (åŒ…æ‹¬æ ‡ç­¾æ›´æ”¹) æ—¶
  issues:
    types: [labeled, unlabeled]

jobs:
  send_email_on_resolved:
    # ä»…åœ¨ Issue æ ‡ç­¾åŒ…å« 'resolved' ä¸” 'unlabeled' äº‹ä»¶æœªå‘ç”Ÿæ—¶è¿è¡Œ
    if: |
      github.event.action == 'labeled' &&
      contains(github.event.issue.labels.*.name, 'resolved')
    runs-on: ubuntu-latest
    
    steps:
    
    - name: ğŸ“© Extract Email from Issue Body (Conditional)
      id: extract_email
      run: |
      
        ISSUE_BODY="${{ github.event.issue.body }}"

        
        LINE_FROM=$(echo "$ISSUE_BODY" | sed -n '2p')

        
        LINE_REPLY_TO=$(echo "$ISSUE_BODY" | sed -n '3p')

        
        TARGET_LINE=""

        
        if echo "$LINE_FROM" | grep -iq "Support"; then
          
          TARGET_LINE="$LINE_REPLY_TO"
          echo "Info: 'From' field contains 'support@filomail.com'. Targeting 'Reply-To' line (Line 3)."
        else
          
          TARGET_LINE="$LINE_FROM"
          echo "Info: 'From' field does not contain 'support@filomail.com'. Targeting 'From' line (Line 2)."
        fi

       
        EMAIL_REGEX='([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)'

        
        email=$(echo "$TARGET_LINE" | grep -o -E "$EMAIL_REGEX")
        
        
        if [ -z "$email" ]; then
          echo "::error::Could not find email address in the target line: $TARGET_LINE. Skipping email."
          echo "extracted_email=no-reply@example.com" >> "$GITHUB_OUTPUT"
        else
          echo "Extracted email: $email"
          echo "extracted_email=$email" >> "$GITHUB_OUTPUT"
        fi
      shell: bash
      
    

      # 2. å‘é€ Resolved é€šçŸ¥é‚®ä»¶
      - name: âœ‰ï¸ Send Resolved Notification Email
        uses: dawidd6/action-send-mail@v3
        # ä»…åœ¨æˆåŠŸæå–åˆ°é‚®ç®±åæ‰è¿è¡Œ
        if: success() && steps.extract_email.outputs.extracted_email != 'no-reply@example.com'
        with:
          # ... (SMTP é…ç½®ä¸å˜) ...
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.MAIL_FROM }}
          
          # ä½¿ç”¨ä¸Šä¸€æ­¥éª¤æå–çš„é‚®ç®±ä½œä¸ºæ”¶ä»¶äºº
          to: ${{ steps.extract_email.outputs.extracted_email }}
          
          # ... (é‚®ä»¶å†…å®¹é…ç½®ä¸å˜) ...
          subject: "[Resolved] Issue # ${{ github.event.issue.number }}: ${{ github.event.issue.title }}"
          html_body: |
            <p>Dear reporterï¼Œ</p>
            <p>Your submitted GitHub Issue status has been updated:</p>
            <ul>
              <li><strong>Issue Title:</strong> <a href="${{ github.event.issue.html_url }}">${{ github.event.issue.title }}</a></li>
              <li><strong>New status:</strong> <strong> Resolved </strong></li>
            </ul>
            <p><strong><a href="${{ github.event.issue.html_url }}">Click here to view the Issue details.</a></strong></p>
            <br>
            <p>Please note: This email was sent automatically by GitHub Actions. Please do not reply directly.</p>
