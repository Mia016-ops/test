name: Notify User Notification

on:
  issues:
    types: [labeled]

jobs:
  send_email_update:
    runs-on: ubuntu-latest

    # 权限设置，有时需要此项
    permissions:
      issues: read 
      contents: read

    # 条件判断：匹配您实际使用的标签 'resolved'
    if: github.event.action == 'labeled' && github.event.label.name == 'resolved'

    steps:
      # 1. Debug：检查事件是否被正确捕获
      - name: Debug Event and Label
        run: |
          echo "Action Triggered. Label: ${{ github.event.label.name }}"
          echo "Issue Body Start: ${{ github.event.issue.body }}"

      # 2. 提取用户邮箱地址 (最终、最安全的版本)
      - name: Extract User Email
        id: extract_email
        run: |
          # 将 Issue Body 安全地写入一个临时文件 (克服换行符和引号问题)
          printf "%s" "${{ github.event.issue.body }}" > issue_body.txt
          
          # 使用 cat 安全地读取文件，并用 sed/awk 提取邮箱
          EMAIL=$(cat issue_body.txt | grep "用户邮箱:" | sed -E 's/.*用户邮箱:[[:space:]]*//' | tr -d '\r\n"' | awk '{print $1}')
          
          # 验证邮箱是否提取成功
          if [ -z "$EMAIL" ]; then
            echo "Error: Could not extract email. Please check the Issue body for '用户邮箱:' format."
            # 为了调试，输出 Issue Body 的所有内容
            cat issue_body.txt
            exit 1
          fi

          echo "Successfully Extracted Email: $EMAIL"
          echo "user_email=$EMAIL" >> $GITHUB_OUTPUT
        shell: bash
        
      # 3. 发送邮件
      - name: Send Resolution Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '工单更新：已解决'
          to: ${{ steps.extract_email.outputs.user_email }}
          from: ${{ secrets.SMTP_USERNAME }}
          body: |
            您的工单 #${{ github.event.issue.number }} 已解决。
            Filo
